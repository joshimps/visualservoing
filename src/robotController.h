#include "robot.h"
#include "ros/ros.h"
#include "geometry_msgs/PoseWithCovariance.h"
#include "geometry_msgs/PoseStamped.h"
#include "eigen3/Eigen/Dense"
#include "std_msgs/Float64MultiArray.h"
#include "geometry_msgs/PoseStamped.h"
#include "rosgraph_msgs/Clock.h"
#include <atomic>
#include <mutex>
#include <vector>
#include <thread>

class RobotController{
    public:

    ///////////////////////////////////////////////////////////////////////////////////////////
    // Constructors and Destructors
    /////////////////////////////////////////////////////////////////////////////////////////

    RobotController(ros::NodeHandle nh, Robot* robot, double gain, double errorThreshold);

    ///////////////////////////////////////////////////////////
    // Action
    //////////////////////////////////////////////////////////

    void moveRobot();
    void stallRobot();
    void calculateEndEffectorVelocity();


    ///////////////////////////////////////////////////////////////////////////////////////////
    // Getters
    /////////////////////////////////////////////////////////////////////////////////////////

    Eigen::VectorXd getEndEffectorVelocity();
    
    ///////////////////////////////////////////////////////////////////////////////////////////
    // Setters
    /////////////////////////////////////////////////////////////////////////////////////////

    void setFiducialPostition(Eigen::MatrixXd fiducialTranslationLocal , Eigen::Quaterniond fiducialRotationLocal);

    private:
   
    ///////////////////////////////////////////////////////////
    // Callbacks and Services
    //////////////////////////////////////////////////////////

    void fiducialPositionCallBack(const geometry_msgs::PoseStampedPtr &msg);
    void clockCallback(const rosgraph_msgs::ClockConstPtr &msg);

    ///////////////////////////////////////////////////////////////////////
    // Node, Publishers and Subscribers
    /////////////////////////////////////////////////////////////////////

    ros::NodeHandle nh_;
    ros::Subscriber fiducialPositionSub_;
    ros::Subscriber clockSub_;
    ros::Publisher jointVelocityPub_;
    ros::Publisher endEffectorVelocityPub_;
    ros::Publisher fiducialNewPose_;

    ///////////////////////////////////////////////////////////////////////
    // Data Security and Pointers
    /////////////////////////////////////////////////////////////////////
    std::mutex fiducialPoseMutex_;

    ///////////////////////////////////////////////////////////////////////
    // Controller Parameters
    /////////////////////////////////////////////////////////////////////
    double gain_;
    double errorThreshold_;
    double euclidianNorm_;

    ///////////////////////////////////////////////////////////////////////
    // Variables
    /////////////////////////////////////////////////////////////////////
    
    Eigen::Vector3d fiducialTranslationLocal_;
    Eigen::Quaterniond fiducialRotationLocal_;
    Eigen::VectorXd endEffectorVelocity_;
    ros::Time timeAtFiducialPublish_;

    ///////////////////////////////////////////////////////////////////////
    // Robot To Control Velocity
    /////////////////////////////////////////////////////////////////////
    Robot* robot_;

    ///////////////////////////////////////////////////////////////////////
    // Flags
    /////////////////////////////////////////////////////////////////////
    bool recievedFiducial_;
};